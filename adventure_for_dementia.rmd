---
title: "Adventure for Dementia"
author: "Amy Whitehead"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

require(tidyverse)
require(sf)
require(XML)
require(lubridate)
require(showtext)
require(xkcd)
require(emojifont)
require(gganimate)
require(magick)
require(av)
require(paletteer)

animate <- gganimate::animate

this_month <- "June"

# options(gganimate.dev_args = list(fps = 10, start_pause = 5,end_pause = 5, res = 72, height = 20, units = "cm"))
```

```{r functions and constants}

font_add("xkcd", "data/xkcd.ttf")
showtext_auto()

caption_text <- "\nAn adventurous running challenge to raise money for Dementia Canterbury\nFollow my journey at www.facebook.com adventurefordementia.nz"

base_font <- 15

read_gpx <- function(gpx_file){
  # Parse the GPX file
  pfile <- htmlTreeParse(file = gpx_file, error = function(...) {
  }, useInternalNodes = T)
  # Get all elevations, times and coordinates via the respective xpath
  elevations <- as.numeric(xpathSApply(pfile, path = "//trkpt/ele", xmlValue))
  times <- xpathSApply(pfile, path = "//trkpt/time", xmlValue)
  coords <- xpathSApply(pfile, path = "//trkpt", xmlAttrs)
  
  # Extract latitude and longitude from the coordinates
  lats <- as.numeric(coords["lat",])
  lons <- as.numeric(coords["lon",])
  
  data.frame(lat = lats, lon = lons, elevation = elevations, time = times) %>% 
    st_as_sf(coords = c("lon","lat"),crs = 4136) 
  
}

make_monthly_repeats <- function(df, n){
 as.data.frame(lapply(df, rep, n)) %>% 
    mutate(month = n)
}

calculate_distance <- function(df){
  df %>% 
    mutate(lead_dist = geometry[row_number() + 1],
           dist = st_distance(geometry, lead_dist, by_element = T),
           lead_elevation = elevation[row_number() + 1],
           elevation_change = lead_elevation - elevation,
           cum_dist = as.numeric(cumsum(dist))/1000) %>% 
    # remove some funky elevation points
    filter(abs(elevation_change) < 6) %>% 
    mutate(uphill = case_when(elevation_change < 0 ~ 0,
                              TRUE ~ elevation_change),
           cum_uphill = as.numeric(cumsum(uphill)),
           Month = factor(month.name[month])
  )
}

plot_run <- . %>% 
  {ggplot(data = ., aes(cum_dist,elevation,colour = done)) +
      geom_line(show.legend = FALSE) +
      theme_classic(base_size = base_font) +
      labs(subtitle = "Elevation in m",
           x = "Distance in km",
           y = NULL,
           title = "Adventure for\nDementia",
           caption = caption_text) +
      coord_cartesian(expand = FALSE,clip = "off") +
      scale_y_continuous(breaks = c(100,200, 300)) +
      # scale_x_continuous(limits = c(0,68)) +
      theme(strip.background = element_blank(),
            strip.text.y = element_blank(),
            plot.subtitle = element_text(hjust = -0.025),
            plot.title = element_text(hjust = 1,size = 30,vjust = -40),
            plot.caption = element_text(size = rel(0.85)),
            plot.margin = margin(-60,10,5,5),
            text=element_text(family="xkcd"),
            axis.text = element_text(color = "black",size = rel(0.85))) }

```


```{r load data}
pop_track <- st_read("data/pipeline-of-pain.gpx",layer = "tracks")

pop_points <- st_read("data/pipeline-of-pain.gpx",layer = "track_points")

pop_track <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "tracks")

pop_points <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "track_points")


# gpx_file <- "data/The_Pipeline_of_Pain_Strava.gpx"
gpx_file <- "data/pipeline-of-pain.gpx"


pop <- read_gpx(gpx_file)

pop_repeats <- map_dfr(1:12,function(x) make_monthly_repeats(pop,x)) %>% 
  group_by(month) %>% 
  calculate_distance() %>% 
  # # remove some funky elevation points
  # filter(abs(elevation_change) < 6) %>% 
  # add column to indicate it's been run
  mutate(done = case_when(Month %in% 
                            month.name[c(1:which(this_month == month.name))] ~ TRUE,
                          TRUE ~ FALSE)) %>% glimpse
  
month_labels <- pop_repeats %>% 
  filter(cum_dist == max(cum_dist)) %>% 
  # add column to indicate it's been run
  mutate(emoji = case_when(isTRUE(done)~ emoji("running"),
                          TRUE ~ NA_character_)) %>% 
  ungroup %>% 
  select(Month, cum_dist, done,emoji) %>% glimpse



```

```{r make plots}
all_months <- pop_repeats %>% 
  ungroup %>% 
  plot_run() +
  geom_text(data = month_labels,
            aes(y = 250, x = cum_dist + 1 ,label = Month),
            hjust = 0,
            family="xkcd",
            size = base_font * 0.36,
            show.legend = FALSE) +
      facet_grid(Month~.) +
  scale_x_continuous(limits = c(0,72)) +
  scale_colour_manual(values = c("black","black"))

ggsave(all_months,file = "outputs/elevation_all.png",dpi=72,width = 20, height = 20, units = "cm")  

# all_months +
#   labs(caption = NULL) +
#   theme(plot.background = element_rect(fill = "transparent"),
#         panel.background = element_rect(fill = "transparent"),
#         plot.title = element_text(hjust = 1,size = 30,vjust = -40, colour = "transparent"))

ggsave(all_months +
  labs(caption = NULL) +
  theme(plot.background = element_rect(fill = "transparent", colour = "transparent"),
        panel.background = element_rect(fill = "transparent"),
        plot.title = element_text(hjust = 1,size = 30,vjust = -40, colour = "transparent")),
  file = "outputs/elevation_all_poster.png",dpi=72,width = 20, height = 20, units = "cm")
  
progress <- all_months + 
  scale_colour_manual(values = c("black","red")) +
  geom_text(data = month_labels,
            aes(y = 300, x = cum_dist + 11 ,label = emoji),
            hjust = 0,
            family="EmojiOne",
            size = 5,
            show.legend = FALSE)

ggsave(progress,file = paste0("outputs/",this_month,"/elevation_progress.png"),
       dpi=72,width = 20, height = 20, units = "cm")  

# make individual plots for each month
walk(month.name, function(x){
  
  pop_repeats %>% 
  ungroup %>% 
  filter(Month %in% x) %>% 
  plot_run() +
  geom_label(data = month_labels %>% 
              filter(Month %in% x),
            aes(y = 250, x = cum_dist - 0.25 ,label = Month),
            hjust = 1,
            family="xkcd",
            size = base_font * 0.36,
            show.legend = FALSE,label.size = NA) +
  scale_colour_manual(values = c("black","black"))
  

 ggsave(file = paste0("outputs/",x,"/elevation.png"),dpi=72,width = 20, height = 20, units = "cm")
})


event_plot <- pop_repeats %>% 
  ungroup %>% 
  filter(Month %in% this_month) %>% 
  plot_run() +
  # geom_text(data = month_labels %>% 
  #             filter(Month %in% this_month),
  #           aes(y = 225, x = cum_dist/2 ,label = Month),
  #           # hjust = 1,
  #           family="xkcd",
  #           size = base_font*2,
  #           show.legend = FALSE) +
  scale_colour_manual(values = c("black","black")) +
  labs(caption = NULL) +
  theme(plot.title = element_text(hjust = 1,size = 30,vjust = -50),
        plot.subtitle = element_text(hjust = -0.025,vjust = -0.5),
        plot.background = element_rect(fill = "transparent", colour = "transparent"),
        panel.background = element_rect(fill = "transparent"),
        axis.text = element_text(color = "black",size = rel(0.85))) 
  

 ggsave(event_plot,
        file = paste0("outputs/",this_month,"/elevation_wide.svg"),width = 30, height = 15, units = "cm")
 ggsave(event_plot,
        file = paste0("outputs/",this_month,"/elevation_square.svg"),width = 15, height = 15, units = "cm")
 
 ggsave(event_plot + 
          theme(plot.title = element_text(hjust = 1,size = 30,vjust = -50,colour = "transparent")), 
        file = paste0("outputs/",this_month,"/elevation_race_number.svg"),width = 17, height = 17*0.7, units = "cm")
 
# ragg::agg_png("outputs/",this_month,"/elevation_wide.png", width = 30, height = 15, units = "cm", res = 150, scaling = 3,background="transparent")
# event_plot
# dev.off() 
```


```{r animated plots}

calculate_elapsed_time <- function(df){
  df %>% 
    mutate(date_time = parse_date_time(time,tz = "UTC",orders = "%Y-%m-%d%H:%M%S" ) %>% 
             with_tz("Pacific/Auckland"),
           elapsed_time = as.numeric(date_time - min(date_time,na.rm=T)),
           hours = hour(seconds_to_period(elapsed_time)),
           minutes = minute(seconds_to_period(elapsed_time)),
           hours_minutes = hm(paste(hours,minutes, sep=":")),
           month = month(date_time))
}

monthly_effort_files <- dir("data/monthly_efforts/",pattern = "gpx$",full.names = T)

monthly_efforts <- map_df(monthly_effort_files,
                        function(x) read_gpx(x) %>% 
                          mutate(Month = factor(gsub("data/monthly_efforts/Adventure_for_Dementia_|\\.gpx","",x),
                                 levels = month.name))) %>% 
filter(Month %in% month.name[1:which(this_month == month.name)]) %>% 
  group_by(Month) %>% 
  calculate_elapsed_time() %>% 
  calculate_distance %>% 
  na.omit() %>% 
  st_drop_geometry %>% glimpse



animated_plot <- monthly_efforts %>% 
  # hack for colour plotting
  rename(done = Month) %>% 
  mutate(this_month = case_when(done %in% this_month ~TRUE,
                                TRUE ~ FALSE)) %>% 
  plot_run() +
   geom_point(aes(alpha = this_month),size=4) +
  # geom_text(aes(label = done),size = 10) +
  theme(plot.title = element_text(vjust = -10)) +
  transition_reveal(elapsed_time) +
  labs( subtitle = 'Time: {round(frame_along/60/60,1)} hours',
       caption = NULL,
       colour = NULL,
       title = "Adventure for\nDementia",
       y = "Elevation in m") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal") +
  scale_colour_paletteer_d(palette = "rcartocolor::Vivid") +
  scale_alpha_manual(values = c("FALSE"=0.5, "TRUE"=1),guide = 'none') #Bold
  

animated_plot_gif <- gganimate::animate(animated_plot,
                                        res = 72, width = 20, height = 20, units = "cm",
                                        fps = 10, detail = 10, start_pause = 5, end_pause = 10)

anim_save(animated_plot_gif,filename = paste0("outputs/",this_month,"/animated_plot.gif"))

animated_plot_mp4 <- gganimate::animate(animated_plot,
                                    res = 150, width = 15, height = 15, units = "cm",
                                    fps = 7, detail = 7, start_pause = 7, end_pause = 10,
                                    renderer = av_renderer())

anim_save(animated_plot_mp4,filename = paste0("outputs/",this_month,"/animated_plot.mp4"))


```

```{r calculate sunrise-sunset}

require(suncalc)

time_format <- function(hrmn) substr(sprintf("%04d", hrmn),1,2)

# get first Saturday of month
x <- seq(as.Date("2023-01-01"), as.Date("2023-12-31"), by = "day")
# You need to adapt "Monday" to the equivalent in your locale
rundays <- x[weekdays(x) == "Saturday" & as.numeric(format(x, "%d")) <= 7]
names(rundays) <- month.name

daylight_hours <- getSunlightTimes(x,lat = -43.5, lon = 172.6, tz = "Pacific/Auckland",
                 keep = c("dawn","sunrise","sunset","dusk")) %>% 
  mutate(month = month(date),
         daylight = dusk - dawn,
         sunlight = sunset - sunrise,
         expected_time_1.25 = month * 1.250,
         expected_time_1.50 = month * 1.50,
         across(c("dawn","sunrise","sunset","dusk"),~as.numeric(format(.,"%H%M")))) %>% glimpse

ggplot(data = daylight_hours,
       aes(x= date)) +
  geom_ribbon(aes(ymin = sunrise,ymax = sunset), fill="#ffeda0") + 
  geom_ribbon(aes(ymin = dawn,ymax = dusk),alpha = 0.25, fill="#ffeda0") + 
  geom_linerange(data = daylight_hours %>% 
                   filter(date %in% rundays | date %in% as.Date("2023-04-02")), 
                 aes(ymin = sunrise, ymax = sunrise + expected_time_1.25*100 ),
                 colour = "red",lwd = 4) +
  geom_linerange(data = daylight_hours %>% 
                   filter(date %in% rundays | date %in% as.Date("2023-04-02")), 
                 aes(ymin = sunrise, ymax = sunrise + expected_time_1.50*100 ),
                 colour = "red",lwd = 4,alpha = 0.5) +
  scale_x_date(expand=c(0,0),date_breaks = "month",date_labels = "%b") +
  scale_y_continuous(labels=time_format, limits=c(0,2400), 
                     breaks=seq(0, 2400, 200), expand=c(0,0)) + theme(panel.background=element_rect(fill="#525252"),                                                                      panel.grid=element_blank()) +
  labs (x = NULL)
```


```{r , eval = FALSE}

require(terra) # for raster data
require(tidyterra) # for plotting rasters
# require(ggspatial) # for map annotations
require(maptiles) # for map backgrounds

tile_z11 <- get_tiles(st_bbox(st_buffer(st_transform(pop_track,3857),400)),
                       provider = "Stamen.Terrain",#"Esri.WorldTopoMap",#OpenTopoMap",#Stamen.Terrain",
                      crop = TRUE, zoom = 15)

pop_map <- pop_track %>% #read_gpx("data/monthly_efforts/Adventure_for_Dementia_January.gpx") %>% 
  ggplot() +
  geom_spatraster_rgb(data = tile_z11) +
  geom_sf(size = 1.5, colour = "grey30") +
  theme_void() 

ggsave(pop_map,file = "outputs/route_map.png")
  
# january_map <- afd_january %>% 
#   bind_cols(st_coordinates(afd_january)) %>% 

ggplot(aes(X,Y)) +
  geom_spatraster_rgb(data = tile_z11) +
  geom_line(size = 1, colour = "black") +
  theme_void() + 
  theme(text=element_text(family="xkcd"),
        plot.background = element_rect(fill = "white")) +
  # transition_reveal(diff_time) +
  labs(title = "Adventure for Dementia",
       subtitle = 'Time since start: {round(frame_along/60,0)} minutes',
       caption = NULL,
       fill = NULL,
       shape = NULL)

animate_january_map <- gganimate::animate(january_map,fps = 10,start_pause = 5, end_pause = 5,
                                          height = 20, units = "cm",res=72)

anim_save(animate_january_map,filename = "outputs/january_map_animation.gif")
```

https://towardsdatascience.com/how-to-combine-animated-plots-in-r-734c6c952315

```{r join animations together, eval = FALSE}

library(magick)
a_mgif <- image_read("outputs/january_map_animation.gif")
b_mgif <- image_read("outputs/january_animation.gif")

image_info(a_mgif)

new_gif <- image_append(c(a_mgif[1], b_mgif[1]), stack = FALSE)
for(i in 2:100){
  combined <- image_append(c(a_mgif[i], b_mgif[i]), stack = FALSE)
  new_gif <- c(new_gif, combined)
}


image_write(new_gif, "outputs/january_combined_animation.gif")
```


```{r xkcd stickman, eval = FALSE}
xrange <- range(pop_repeats$cum_dist,na.rm= T)
yrange <- range(pop_repeats$elevation,na.rm=T)
ratioxy <- diff(xrange) / diff(yrange)
 
mapping <- aes(x=x,
               y=y,
               scale=scale,
               ratioxy=ratioxy,
               angleofspine = angleofspine,
               anglerighthumerus = anglerighthumerus,
               anglelefthumerus = anglelefthumerus,
               anglerightradius = anglerightradius,
               angleleftradius = angleleftradius,
               anglerightleg =  anglerightleg,
               angleleftleg = angleleftleg,
               angleofneck = angleofneck)
 
dataman <- data.frame( x= c(5), y=c(100),
                  scale = c(10),
                  ratioxy = ratioxy,
                  angleofspine =  -pi / 2,#seq(- pi / 2, -pi/2 + pi/8, l=3) ,
                  anglerighthumerus = -pi/6,
                  anglelefthumerus = pi + pi/6,
                  anglerightradius = 0,
                  angleleftradius = runif(1,- pi/4, pi/4),
                  angleleftleg = 3*pi/2  + pi / 12 ,
                  anglerightleg = 3*pi/2  - pi / 12,
                  angleofneck = runif(1, min = 3 * pi / 2 - pi/10 , max = 3 * pi / 2 + pi/10))
 
january + xkcdman(mapping,dataman)
# }

```

```{r rayshader animated map, eval = FALSE}
# devtools::install_github("zappingseb/rayshaderanimate")
## This code currently doesn't work
require(rayshaderanimate)

test <- get_table_from_gpx(gpx_file) %>% 
  get_enriched_gpx_table()

test_bbox <- get_bbox_from_gpx_table(test)
el_mat <- get_elevdata_from_bbox(test_bbox)
elmat_rayshade <- el_mat %>% unlabel_elevdata()
el_mat_long <- get_elevdata_long(el_mat)

# data(el_mat) # load pre-stored data
# elmat_rayshade <- el_mat %>% unlabel_elevdata()
# elmat_long <- get_elevdata_long(el_mat)

plot_2d_elevdata(elevdata_rayshade = elmat_rayshade)
```

