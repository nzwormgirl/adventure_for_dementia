---
title: "Adventure for Dementia"
author: "Amy Whitehead"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

require(tidyverse)
require(sf)
require(XML)
require(lubridate)
require(showtext)
require(xkcd)
require(emojifont)


```


```{r load data}
pop_track <- st_read("data/pipeline-of-pain.gpx",layer = "tracks")

pop_points <- st_read("data/pipeline-of-pain.gpx",layer = "track_points")

pop_track <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "tracks")

pop_points <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "track_points")


# gpx_file <- "data/The_Pipeline_of_Pain_Strava.gpx"
gpx_file <- "data/pipeline-of-pain.gpx"

# Parse the GPX file
pfile <- htmlTreeParse(file = gpx_file, error = function(...) {
}, useInternalNodes = T)
# Get all elevations, times and coordinates via the respective xpath
elevations <- as.numeric(xpathSApply(pfile, path = "//trkpt/ele", xmlValue))
times <- xpathSApply(pfile, path = "//trkpt/time", xmlValue)
coords <- xpathSApply(pfile, path = "//trkpt", xmlAttrs)

# Extract latitude and longitude from the coordinates
lats <- as.numeric(coords["lat",])
lons <- as.numeric(coords["lon",])

pop <- data.frame(lat = lats, lon = lons, elevation = elevations, time = times) %>% 
  st_as_sf(coords = c("lon","lat"),crs = 4136) %>% glimpse
  mutate(
    lead_dist = geometry[row_number() + 1],
    dist = st_distance(geometry, lead_dist, by_element = T),
    lead_elevation = elevation[row_number() + 1],
    elevation_change = lead_elevation - elevation,
    cum_dist = as.numeric(cumsum(dist))
  ) %>% 
  # remove some funky elevation points
  filter(abs(elevation_change) < 6) %>% 
  glimpse


make_monthly_repeats <- function(df, n){
 as.data.frame(lapply(df, rep, n)) %>% 
    mutate(month = n)
}


pop_repeats <- map_dfr(1:12,function(x) make_monthly_repeats(pop,x)) %>% 
  group_by(month) %>% 
  mutate(
    lead_dist = geometry[row_number() + 1],
    dist = st_distance(geometry, lead_dist, by_element = T),
    lead_elevation = elevation[row_number() + 1],
    elevation_change = lead_elevation - elevation,
    uphill = case_when(elevation_change < 0 ~ 0,
                       TRUE ~ elevation_change),
    cum_dist = as.numeric(cumsum(dist))/1000,
    cum_uphill = as.numeric(cumsum(uphill)),
    Month = factor(month.name[month])
  ) %>% 
  # remove some funky elevation points
  filter(abs(elevation_change) < 6) %>% 
  # add column to indicate it's been run
  mutate(done = case_when(Month %in% "January" ~ TRUE,
                          TRUE ~ FALSE)) %>% glimpse
  
month_labels <- pop_repeats %>% 
  filter(cum_dist == max(cum_dist)) %>% 
  # add column to indicate it's been run
  mutate(emoji = case_when(isTRUE(done)~ emoji("running"),
                          TRUE ~ NA_character_)) %>% 
  ungroup %>% 
  select(Month, cum_dist, done,emoji) %>% glimpse



font_add("xkcd", "data/xkcd.ttf")
showtext_auto()

caption_text <- "\nAn adventurous running challenge to raise money for Dementia Canterbury\nFollow my journey at www.facebook.com adventurefordementia.nz"

base_font <- 15

plot_run <- . %>% 
  {ggplot(data = ., aes(cum_dist,elevation,colour = done)) +
      geom_line(show.legend = FALSE) +
      theme_classic(base_size = base_font) +
      labs(subtitle = "Elevation in m",
           x = "Distance in km",
           y = NULL,
           title = "Adventure for\nDementia",
           caption = caption_text) +
      coord_cartesian(expand = FALSE,clip = "off") +
      scale_y_continuous(breaks = c(100,200, 300)) +
      # scale_x_continuous(limits = c(0,68)) +
      theme(strip.background = element_blank(),
            strip.text.y = element_blank(),
            plot.subtitle = element_text(hjust = -0.025),
            plot.title = element_text(hjust = 1,size = 30,vjust = -40),
            plot.caption = element_text(size = rel(0.85)),
            plot.margin = margin(-60,10,5,5),
            text=element_text(family="xkcd")) }


all_months <- pop_repeats %>% 
  ungroup %>% 
  plot_run() +
  geom_text(data = month_labels,
            aes(y = 250, x = cum_dist + 1 ,label = Month),
            hjust = 0,
            family="xkcd",
            size = base_font * 0.36,
            show.legend = FALSE) +
      facet_grid(Month~.) +
  scale_x_continuous(limits = c(0,72)) +
  scale_colour_manual(values = c("black","black"))

ggsave(all_months,file = "outputs/elevation_all.png",dpi=72,width = 20, height = 20, units = "cm")  
  
progress <- all_months + 
  scale_colour_manual(values = c("black","red")) +
  geom_text(data = month_labels,
            aes(y = 300, x = cum_dist + 11 ,label = emoji),
            hjust = 0,
            family="EmojiOne",
            size = 5,
            show.legend = FALSE)

ggsave(progress,file = "outputs/elevation_progress.png",dpi=72,width = 20, height = 20, units = "cm")  

january <- pop_repeats %>% 
  ungroup %>% 
  filter(Month %in% "January") %>% 
  plot_run() +
  geom_text(data = month_labels %>% 
              filter(Month %in% "January"),
            aes(y = 250, x = cum_dist - 0.25 ,label = Month),
            hjust = 1,
            family="xkcd",
            size = base_font * 0.36,
            show.legend = FALSE) +
  scale_colour_manual(values = c("black","black"))
  

 ggsave(january,file = "outputs/elevation_january.png",dpi=72,width = 20, height = 20, units = "cm")
 
```

```{r , eval = FALSE}

require(terra) # for raster data
require(tidyterra) # for plotting rasters
require(ggspatial) # for map annotations
require(maptiles) # for map backgrounds

Stamen.TerrainBackground = list(
        src = "Stamen.TerrainBK",
        q = '"https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.png"',
        sub = c("a", "b", "c", "d"),
        cit = "Map tiles by CC BY 3.0 \u2014 Map data \u00A9 OpenStreetMap contributors"
      )

CyclOSM = list(
        src = "CyclOSM",
        q = '"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png"',
        sub = c("a", "b", "c", "d"),
        cit = ""
      )

osm <- list(
  src = 'OSM',
  q = '"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"',
  sub = c('a','b', 'c'),
  cit = 'Â© OpenStreetMap contributors.'
)

tile_z11 <- get_tiles(st_bbox(st_buffer(st_transform(pop_track,3857),350)),
                       provider = "Stamen.Terrain",
                      crop = TRUE, zoom = 15)

ggplot() +
  geom_spatraster_rgb(data = tile_z11) +
  geom_sf(data = pop_track, 
          size = 1.5,colour = "black") + #shape = 21,
  labs(caption = NULL,
       fill = NULL,
       shape = NULL) +
  theme_void() + 
  theme(legend.position = "right",
        legend.direction = "vertical",
        legend.box.margin = margin(-5,0,-10,0),
        legend.margin = margin(0,0,0,0)) +
  annotation_scale(style = "ticks",location = "br") 



```

```{r xkcd stickman}
xrange <- range(pop_repeats$cum_dist,na.rm= T)
yrange <- range(pop_repeats$elevation,na.rm=T)
ratioxy <- diff(xrange) / diff(yrange)
 
mapping <- aes(x=x,
               y=y,
               scale=scale,
               ratioxy=ratioxy,
               angleofspine = angleofspine,
               anglerighthumerus = anglerighthumerus,
               anglelefthumerus = anglelefthumerus,
               anglerightradius = anglerightradius,
               angleleftradius = angleleftradius,
               anglerightleg =  anglerightleg,
               angleleftleg = angleleftleg,
               angleofneck = angleofneck)
 
dataman <- data.frame( x= c(5), y=c(100),
                  scale = c(10),
                  ratioxy = ratioxy,
                  angleofspine =  -pi / 2,#seq(- pi / 2, -pi/2 + pi/8, l=3) ,
                  anglerighthumerus = -pi/6,
                  anglelefthumerus = pi + pi/6,
                  anglerightradius = 0,
                  angleleftradius = runif(1,- pi/4, pi/4),
                  angleleftleg = 3*pi/2  + pi / 12 ,
                  anglerightleg = 3*pi/2  - pi / 12,
                  angleofneck = runif(1, min = 3 * pi / 2 - pi/10 , max = 3 * pi / 2 + pi/10))
 
january + xkcdman(mapping,dataman)
# }

```

