---
title: "Adventure for Dementia"
author: "Amy Whitehead"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

require(tidyverse)
require(sf)
require(XML)
require(lubridate)


```


```{r load data}
pop_track <- st_read("data/pipeline-of-pain.gpx",layer = "tracks")

pop_points <- st_read("data/pipeline-of-pain.gpx",layer = "track_points")

pop_track <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "tracks")

pop_points <- st_read("data/The_Pipeline_of_Pain_Strava.gpx",layer = "track_points")


# gpx_file <- "data/The_Pipeline_of_Pain_Strava.gpx"
gpx_file <- "data/pipeline-of-pain.gpx"

# Parse the GPX file
pfile <- htmlTreeParse(file = gpx_file, error = function(...) {
}, useInternalNodes = T)
# Get all elevations, times and coordinates via the respective xpath
elevations <- as.numeric(xpathSApply(pfile, path = "//trkpt/ele", xmlValue))
times <- xpathSApply(pfile, path = "//trkpt/time", xmlValue)
coords <- xpathSApply(pfile, path = "//trkpt", xmlAttrs)

# Extract latitude and longitude from the coordinates
lats <- as.numeric(coords["lat",])
lons <- as.numeric(coords["lon",])

pop <- data.frame(lat = lats, lon = lons, elevation = elevations, time = times) %>% 
  st_as_sf(coords = c("lon","lat"),crs = 4136) %>% glimpse
  mutate(
    lead_dist = geometry[row_number() + 1],
    dist = st_distance(geometry, lead_dist, by_element = T),
    lead_elevation = elevation[row_number() + 1],
    elevation_change = lead_elevation - elevation,
    cum_dist = as.numeric(cumsum(dist))
  ) %>% 
  # remove some funky elevation points
  filter(abs(elevation_change) < 6) %>% 
  glimpse


make_monthly_repeats <- function(df, n){
 as.data.frame(lapply(df, rep, n)) %>% 
    mutate(month = n)
}


pop_repeats <- map_dfr(1:12,function(x) make_monthly_repeats(pop,x)) %>% 
  group_by(month) %>% 
  mutate(
    lead_dist = geometry[row_number() + 1],
    dist = st_distance(geometry, lead_dist, by_element = T),
    lead_elevation = elevation[row_number() + 1],
    elevation_change = lead_elevation - elevation,
    uphill = case_when(elevation_change < 0 ~ 0,
                       TRUE ~ elevation_change),
    cum_dist = as.numeric(cumsum(dist))/1000,
    cum_uphill = as.numeric(cumsum(uphill)),
    Month = factor(month.name[month])
  ) %>% 
  # remove some funky elevation points
  filter(abs(elevation_change) < 6) %>% 
  glimpse
  
month_labels <- pop_repeats %>% 
  filter(cum_dist == max(cum_dist)) %>% glimpse

library(showtext)

font_add("xkcd", "data/xkcd.ttf")
showtext_auto()


pop_repeats %>% 
ggplot(aes(cum_dist,elevation)) +
  geom_line() +
  geom_text(data = month_labels,aes(y = 250, x = cum_dist + 1,label = Month),hjust = 0,family="xkcd") +
  facet_grid(Month~.,) +
  theme_classic() +
  labs(subtitle = "Elevation in m",
       x = "Distance in km",
       y = NULL,
       title = "Adventure for\nDementia",
       caption = "\nI'm raising money to support Dementia Canterbury by running the Pipeline of Pain a lot in 2023!\nFollow my journey at www.facebook.com/adventurefordementia.nz") +
  coord_cartesian(expand = FALSE,clip = "off") +
  scale_y_continuous(breaks = c(100,200, 300)) +
  scale_x_continuous(limits = c(0,68)) +
  theme(strip.background = element_blank(),
        strip.text.y = element_blank(),
        plot.subtitle = element_text(hjust = -0.025),
        plot.title = element_text(hjust = 1,size = 40,vjust = -10),
        plot.caption = element_text(size = 12),
        plot.margin = margin(-60,10,5,5),
        text=element_text(family="xkcd")) 
```

```{r}

```

